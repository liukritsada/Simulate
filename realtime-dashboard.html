<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Live Real-time Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        :root {
            --primary: #0066CC;
            --primary-light: #3399FF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text: #1F2937;
            --text-light: #6B7280;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
        }
        body {
            background: linear-gradient(135deg, #F5FAFF 0%, #E0EEFF 50%, #F0F5FF 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .header p {
            font-size: 1.1rem;
            color: var(--text-light);
        }
        .status-bar {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: 0 4px 16px rgba(0, 102, 204, 0.08);
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .status-dot.offline {
            background: var(--danger);
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .update-time {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 8px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }
        .grid.full {
            grid-template-columns: 1fr;
        }
        .chart-container {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 102, 204, 0.08);
        }
        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text);
        }
        .controls {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0, 102, 204, 0.08);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 102, 204, 0.2);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #F87171 100%);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.2);
        }
        .note {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            color: var(--text);
        }
        .code-block {
            background: #1F2937;
            color: #E5E7EB;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin-top: 16px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.75rem;
            }
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Live Real-time Dashboard</h1>
            <p>Real-time data integration ‡∏à‡∏≤‡∏Å API endpoints</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span>API Status: <strong>Online</strong></span>
            </div>
            <div class="status-item">
                <i class="fas fa-sync-alt"></i>
                <span>Update Interval: <strong>5s</strong></span>
            </div>
            <div class="status-item">
                <i class="fas fa-chart-line"></i>
                <span id="chartCount">Charts: <strong>0</strong></span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="startAllCharts()">
                <i class="fas fa-play"></i> Start All Charts
            </button>
            <button class="btn btn-danger" onclick="stopAllCharts()">
                <i class="fas fa-stop"></i> Stop All Charts
            </button>
            <button class="btn btn-primary" onclick="updateCharts()">
                <i class="fas fa-sync-alt"></i> Manual Refresh
            </button>
            <span style="margin-left: auto; font-size: 0.9rem; color: var(--text-light);">
                <i class="fas fa-info-circle"></i>
                Charts update automatically every 5 seconds
            </span>
        </div>

        <div class="note">
            <strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà API endpoints ‡∏î‡πâ‡∏ß‡∏¢ endpoints ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô 
            <code style="background: white; padding: 2px 6px; border-radius: 3px;">/hospital/api/get_stations.php</code>,
            <code style="background: white; padding: 2px 6px; border-radius: 3px;">/hospital/api/get_station_stats.php</code> ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
        </div>

        <div class="grid">
            <!-- Live Metrics -->
            <div class="chart-container">
                <div class="chart-title">üìà Patient Metrics (Live)</div>
                <div id="metricsChart"></div>
                <div class="code-block">// Data from: /hospital/api/get_station_stats.php
rtDataManager.subscribe('mock/stats', 
  (data) => console.log('Stats updated:', data)
);</div>
            </div>

            <!-- Live Bar Chart -->
            <div class="chart-container">
                <div class="chart-title">üìä Station Occupancy (Live)</div>
                <div id="barChart"></div>
                <div class="code-block">// Data from: /hospital/api/get_stations_with_staff.php
liveChartManager.createLiveBarChart(
  'barChart', 'get_stations.php', 
  transformStationStats, 'üìä Occupancy'
);</div>
            </div>

            <!-- Live Donut Chart -->
            <div class="chart-container">
                <div class="chart-title">üç© Status Distribution (Live)</div>
                <div id="donutChart"></div>
                <div class="code-block">// Transform API data to donut format
liveChartManager.createLiveDonut(
  'donutChart', 'get_station_stats.php',
  transformStationDonut, 'üç© Distribution'
);</div>
            </div>

            <!-- Live Progress -->
            <div class="chart-container">
                <div class="chart-title">‚è≥ Room Occupancy (Live)</div>
                <div id="progressChart"></div>
                <div class="code-block">// Track occupancy levels in real-time
liveChartManager.createLiveProgress(
  'progressChart', 'get_station_stats.php',
  transformOccupancy
);</div>
            </div>

            <!-- Live Stats Table -->
            <div class="chart-container full">
                <div class="chart-title">üìã Station Statistics (Live)</div>
                <div id="tableChart"></div>
                <div class="code-block">// Create live table with real-time updates
liveChartManager.createLiveTable(
  'tableChart', 'get_stations.php',
  [/* columns */], transformTableRows, 'üìä Stats'
);</div>
            </div>
        </div>

        <!-- Usage Documentation -->
        <div style="margin-top: 40px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 102, 204, 0.08);">
            <h2 style="font-size: 1.3rem; margin-bottom: 16px; color: var(--primary);">üîß Usage Guide</h2>
            
            <h3 style="font-size: 1.1rem; margin: 20px 0 12px 0; color: var(--text);">1. Create Realtime Data Manager</h3>
            <div class="code-block">const rtDataManager = new RealtimeDataManager({
    apiBase: '/hospital/api/',
    updateInterval: 5000, // 5 seconds
    useSSE: true
});</div>

            <h3 style="font-size: 1.1rem; margin: 20px 0 12px 0; color: var(--text);">2. Create Live Chart Manager</h3>
            <div class="code-block">const liveChartManager = new LiveChartManager(rtDataManager);</div>

            <h3 style="font-size: 1.1rem; margin: 20px 0 12px 0; color: var(--text);">3. Create Live Chart</h3>
            <div class="code-block">liveChartManager.createLiveBarChart(
    'chartContainer',
    'get_stations.php',  // API endpoint
    transformStationStats,  // Data transformer function
    'üìä Station Chart'  // Title
);</div>

            <h3 style="font-size: 1.1rem; margin: 20px 0 12px 0; color: var(--text);">4. Data Transformer Function</h3>
            <div class="code-block">function transformStationStats(data) {
    return data.stations.map(station => ({
        label: station.station_name,
        value: station.patient_count,
        max: 100,
        color: 'success'
    }));
}</div>

            <h3 style="font-size: 1.1rem; margin: 20px 0 12px 0; color: var(--text);">5. Available Methods</h3>
            <ul style="margin-left: 20px; color: var(--text); line-height: 1.8;">
                <li><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">createLiveBarChart()</code> - ‡∏™‡∏£‡πâ‡∏≤‡∏á Bar Chart ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</li>
                <li><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">createLiveMetrics()</code> - ‡∏™‡∏£‡πâ‡∏≤‡∏á Metric Cards ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</li>
                <li><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">createLiveDonut()</code> - ‡∏™‡∏£‡πâ‡∏≤‡∏á Donut Chart ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</li>
                <li><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">createLiveProgress()</code> - ‡∏™‡∏£‡πâ‡∏≤‡∏á Progress Indicator ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</li>
                <li><code style="background: var(--gray-100); padding: 2px 6px; border-radius: 3px;">createLiveTable()</code> - ‡∏™‡∏£‡πâ‡∏≤‡∏á Table ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</li>
            </ul>
        </div>
    </div>

    <script src="js/modules/15-data-visualization.js"></script>
    <script src="js/modules/16-realtime-integration.js"></script>
    <script>
        // Mock data functions for demo
        function getMockStations() {
            return {
                success: true,
                data: {
                    stations: [
                        { station_name: 'ICU', station_code: 'ICU', patient_count: Math.floor(Math.random() * 30) + 10, total_staff: Math.floor(Math.random() * 15) + 5, total_doctors: Math.floor(Math.random() * 8) + 2, room_count: Math.floor(Math.random() * 10) + 5, floor: 1, total_procedures: Math.floor(Math.random() * 20) },
                        { station_name: 'Emergency', station_code: 'ER', patient_count: Math.floor(Math.random() * 40) + 15, total_staff: Math.floor(Math.random() * 20) + 8, total_doctors: Math.floor(Math.random() * 12) + 4, room_count: Math.floor(Math.random() * 15) + 8, floor: 1, total_procedures: Math.floor(Math.random() * 30) },
                        { station_name: 'Out-Patient', station_code: 'OPD', patient_count: Math.floor(Math.random() * 60) + 20, total_staff: Math.floor(Math.random() * 25) + 10, total_doctors: Math.floor(Math.random() * 15) + 5, room_count: Math.floor(Math.random() * 20) + 10, floor: 2, total_procedures: Math.floor(Math.random() * 40) },
                        { station_name: 'Operating Theater', station_code: 'OT', patient_count: Math.floor(Math.random() * 20) + 5, total_staff: Math.floor(Math.random() * 18) + 6, total_doctors: Math.floor(Math.random() * 10) + 3, room_count: Math.floor(Math.random() * 8) + 3, floor: 2, total_procedures: Math.floor(Math.random() * 25) },
                        { station_name: 'Cardiology', station_code: 'CARDIO', patient_count: Math.floor(Math.random() * 25) + 8, total_staff: Math.floor(Math.random() * 12) + 4, total_doctors: Math.floor(Math.random() * 8) + 2, room_count: Math.floor(Math.random() * 10) + 5, floor: 3, total_procedures: Math.floor(Math.random() * 20) },
                        { station_name: 'Radiology', station_code: 'RAD', patient_count: Math.floor(Math.random() * 30) + 10, total_staff: Math.floor(Math.random() * 14) + 5, total_doctors: Math.floor(Math.random() * 8) + 2, room_count: Math.floor(Math.random() * 12) + 6, floor: 3, total_procedures: Math.floor(Math.random() * 25) },
                        { station_name: 'Laboratory', station_code: 'LAB', patient_count: Math.floor(Math.random() * 50) + 15, total_staff: Math.floor(Math.random() * 16) + 6, total_doctors: Math.floor(Math.random() * 6) + 1, room_count: Math.floor(Math.random() * 8) + 4, floor: 4, total_procedures: Math.floor(Math.random() * 50) },
                        { station_name: 'Pharmacy', station_code: 'PHARM', patient_count: Math.floor(Math.random() * 40) + 10, total_staff: Math.floor(Math.random() * 18) + 7, total_doctors: Math.floor(Math.random() * 4) + 1, room_count: Math.floor(Math.random() * 10) + 5, floor: 4, total_procedures: Math.floor(Math.random() * 35) }
                    ]
                }
            };
        }

        function getMockStats() {
            return {
                success: true,
                data: {
                    total_patients: Math.floor(Math.random() * 200) + 50,
                    total_change: Math.floor(Math.random() * 20) - 10,
                    waiting_count: Math.floor(Math.random() * 80) + 10,
                    waiting_change: Math.floor(Math.random() * 10) - 5,
                    processing_count: Math.floor(Math.random() * 60) + 10,
                    processing_change: Math.floor(Math.random() * 8) - 4,
                    completed_count: Math.floor(Math.random() * 150) + 30,
                    completed_change: Math.floor(Math.random() * 15) - 5,
                    empty_count: Math.floor(Math.random() * 30) + 10,
                    occupied_count: Math.floor(Math.random() * 50) + 20,
                    maintenance_count: Math.floor(Math.random() * 10) + 2
                }
            };
        }

        // Override fetch for demo
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('mock/stations')) {
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve(getMockStations())
                });
            } else if (url.includes('mock/stats')) {
                return Promise.resolve({
                    ok: true,
                    json: () => Promise.resolve(getMockStats())
                });
            }
            return originalFetch.apply(this, arguments);
        };

        // Initialize live charts
        function startAllCharts() {
            console.log('üöÄ Starting all live charts...');
            
            // Data transformers
            const stationsToMetrics = (response) => {
                if (!response.success || !response.data || !response.data.stations) return [];
                const stations = response.data.stations;
                const totalStations = stations.length;
                const totalStaff = stations.reduce((sum, s) => sum + (s.total_staff || 0), 0);
                const totalDoctors = stations.reduce((sum, s) => sum + (s.total_doctors || 0), 0);
                const totalRooms = stations.reduce((sum, s) => sum + (s.room_count || 0), 0);
                
                return [
                    { label: 'Stations', value: totalStations, change: 0, icon: 'üè•', color: '#0066CC' },
                    { label: 'Rooms', value: totalRooms, change: 0, icon: 'üö™', color: '#F59E0B' },
                    { label: 'Staff', value: totalStaff, change: 0, icon: 'üë®‚Äç‚öïÔ∏è', color: '#10B981' },
                    { label: 'Doctors', value: totalDoctors, change: 0, icon: 'üë®‚Äçüî¨', color: '#3B82F6' },
                    { label: 'Avg Staff/Stn', value: (totalStaff/totalStations).toFixed(1), change: 0, icon: 'üìä', color: '#8B5CF6' },
                    { label: 'Avg Rooms/Stn', value: (totalRooms/totalStations).toFixed(1), change: 0, icon: 'üìà', color: '#EC4899' }
                ];
            };

            const stationsToBarChart = (response) => {
                if (!response.success || !response.data || !response.data.stations) return [];
                return response.data.stations.map(station => ({
                    label: station.station_code + ' - ' + station.station_name,
                    value: station.total_staff || 0,
                    max: 30,
                    color: station.total_staff > 15 ? '#EF4444' : station.total_staff > 10 ? '#F59E0B' : '#10B981'
                }));
            };

            const stationsToDonut = (response) => {
                if (!response.success || !response.data || !response.data.stations) return [];
                const stations = response.data.stations;
                const totalStaff = stations.reduce((sum, s) => sum + (s.total_staff || 0), 0);
                const totalDoctors = stations.reduce((sum, s) => sum + (s.total_doctors || 0), 0);
                const totalRooms = stations.reduce((sum, s) => sum + (s.room_count || 0), 0);
                
                return [
                    { label: 'Staff', value: totalStaff, color: '#10B981' },
                    { label: 'Doctors', value: totalDoctors, color: '#3B82F6' },
                    { label: 'Rooms', value: totalRooms, color: '#F59E0B' }
                ];
            };

            const stationsToProgress = (response) => {
                if (!response.success || !response.data || !response.data.stations) return [];
                const stations = response.data.stations;
                const totalRooms = stations.reduce((sum, s) => sum + (s.room_count || 0), 0);
                const totalStaff = stations.reduce((sum, s) => sum + (s.total_staff || 0), 0);
                const totalDoctors = stations.reduce((sum, s) => sum + (s.total_doctors || 0), 0);
                
                return [
                    { label: 'Rooms Capacity', value: totalRooms, max: totalRooms + 10, color: 'var(--warning)' },
                    { label: 'Staff Assigned', value: totalStaff, max: totalRooms + 10, color: 'var(--success)' },
                    { label: 'Doctors Assigned', value: totalDoctors, max: totalRooms + 10, color: 'var(--primary)' }
                ];
            };

            const stationsToTable = (response) => {
                if (!response.success || !response.data || !response.data.stations) return [];
                return response.data.stations.map(station => ({
                    station_name: station.station_name,
                    station_code: station.station_code,
                    floor: station.floor || '-',
                    rooms: station.room_count || 0,
                    staff: station.total_staff || 0,
                    doctors: station.total_doctors || 0,
                    procedures: station.total_procedures || 0
                }));
            };
            
            // Live Metrics
            liveChartManager.createLiveMetrics(
                'metricsChart',
                'mock/stations',
                stationsToMetrics
            );

            // Live Bar Chart
            liveChartManager.createLiveBarChart(
                'barChart',
                'mock/stations',
                stationsToBarChart,
                'üë• Staff per Station'
            );

            // Live Donut Chart
            liveChartManager.createLiveDonut(
                'donutChart',
                'mock/stations',
                stationsToDonut,
                'üìä Resource Distribution'
            );

            // Live Progress
            liveChartManager.createLiveProgress(
                'progressChart',
                'mock/stations',
                stationsToProgress
            );

            // Live Table
            liveChartManager.createLiveTable(
                'tableChart',
                'mock/stations',
                [
                    { title: 'Station', key: 'station_name' },
                    { title: 'Code', key: 'station_code' },
                    { title: 'Floor', key: 'floor' },
                    { title: 'Rooms', key: 'rooms' },
                    { title: 'Staff', key: 'staff' },
                    { title: 'Doctors', key: 'doctors' },
                    { title: 'Procedures', key: 'procedures' }
                ],
                stationsToTable,
                'üìã Comprehensive Station Statistics'
            );

            updateChartCount();
            alert('‚úÖ All comprehensive live charts started!\nData will update every 5 seconds.');
        }

        function stopAllCharts() {
            console.log('üõë Stopping all live charts...');
            liveChartManager.stopAll();
            updateChartCount();
            alert('‚úÖ All live charts stopped');
        }

        function updateCharts() {
            console.log('üîÑ Manual refresh...');
            rtDataManager.stopAll();
            startAllCharts();
        }

        function updateChartCount() {
            const count = Object.keys(liveChartManager.charts).length;
            document.getElementById('chartCount').textContent = `Charts: ${count}`;
        }

        // Auto-start on page load
        window.addEventListener('load', () => {
            console.log('üìä Live Dashboard loaded');
        });
    </script>
</body>
</html>
